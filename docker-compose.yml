version: "3.8"

services:
  # Qdrant 向量数据库
  qdrant:
    image: qdrant/qdrant:v1.15.0
    container_name: gc-doc-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
    volumes:
      - ./storage/qdrant:/qdrant/storage
    networks:
      - internal
    deploy:
      resources:
        limits:
          memory: 2G

  # RAG 搜索服务（内部）
  rag-service:
    build: .
    container_name: gc-doc-rag
    restart: unless-stopped
    depends_on:
      - qdrant
    environment:
      VOYAGE_API_KEY: ${VOYAGE_API_KEY}
      QDRANT_URL: http://qdrant:6333
    volumes:
      - ./storage/logs:/app/storage/logs
      - ./storage/checkpoints:/app/storage/checkpoints
      - ./raw_data:/app/raw_data:ro
    networks:
      - internal
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8888/health').raise_for_status()"]
      interval: 15s
      timeout: 5s
      retries: 3

  # MCP 服务（对外）
  mcp-server:
    build: .
    container_name: gc-doc-mcp
    restart: unless-stopped
    depends_on:
      rag-service:
        condition: service_healthy
    command: ["python", "scripts/serve.py", "--mode", "mcp"]
    environment:
      RAG_SERVICE_URL: http://rag-service:8888
    ports:
      - "${MCP_PORT:-8889}:8889"
    volumes:
      - ./storage/logs:/app/storage/logs
    networks:
      - internal
      - external
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8889/health').raise_for_status()"]
      interval: 15s
      timeout: 5s
      retries: 3

networks:
  internal:
    driver: bridge
  external:
    driver: bridge
